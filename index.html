<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Greenâ€¯Fest QR Stampâ€¯Rally</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <script src="https://unpkg.com/html5-qrcode@2.3.10/html5-qrcode.min.js"></script>
  <style>
    body{background:#f6fdf7}
    #reader{width:100%;max-width:400px;margin:auto;border:2px solid #198754;border-radius:12px}
  </style>
</head>
<body class="d-flex flex-column align-items-center gap-3 pt-4">
  <h1 class="h4 fw-bold text-success mb-0">ğŸŒ¿ Green Fest QR ìŠ¤íƒ¬í”„ë ë¦¬</h1>

  <!-- ë¡œê·¸ì¸ ì˜ì—­ -->
  <div id="auth-area" class="text-center w-100" style="max-width:380px;">
    <label class="form-label fw-semibold mt-3">í•™ë²ˆ / íœ´ëŒ€í° ë²ˆí˜¸</label>
    <input id="uid-input" class="form-control mb-2" placeholder="20251234" />
    <button id="login-btn" class="btn btn-success w-100">ë¡œê·¸ì¸</button>
    <small class="text-muted d-block mt-2">ì¹´ë©”ë¼ ê¶Œí•œì€ ë¡œê·¸ì¸ í›„ ìš”ì²­ë©ë‹ˆë‹¤.</small>
  </div>

  <!-- ë©”ì¸ UI -->
  <div id="main-ui" class="d-none w-100 flex-column align-items-center gap-3">
    <div id="stamp-counter" class="badge text-bg-success fs-6 px-3 py-2"></div>

    <!-- ìŠ¤ìºë„ˆ ì‹œì‘ ì „ ì•ˆë‚´ -->
    <button id="start-scan" class="btn btn-outline-success">ì¹´ë©”ë¼ë¡œ QR ìŠ¤ìº” ì‹œì‘</button>
    <div id="reader" class="d-none"></div>
    <div id="scan-msg" class="text-danger small"></div>

    <button id="logout-btn" class="btn btn-outline-secondary btn-sm">ë¡œê·¸ì•„ì›ƒ</button>
  </div>

  <!-- ë¦¬ì›Œë“œ ëª¨ë‹¬ -->
  <div class="modal fade" id="rewardModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content text-center p-4">
        <h2 class="fw-bold text-success mb-3">ğŸ ì¶•í•˜í•©ë‹ˆë‹¤!</h2>
        <p id="reward-text" class="fs-5"></p>
        <button class="btn btn-success" data-bs-dismiss="modal">ë‹«ê¸°</button>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
  /* ========= CONFIG ========= */
  const SCRIPT_API_BASE = "https://script.google.com/macros/s/AKfycbyRe_83IJ0G_bBSd2xAD6Cc0fgOX-71X8jIEzJ5bohs8fft0_MN8bWFhB072T_SiBoZ/exec"; // â˜… replace with your WebApp URL
  const MIN_STAMPS_FOR_REWARD = 5;

  /* ====== ELEMENTS ====== */
  const authArea     = document.getElementById('auth-area');
  const uidInput     = document.getElementById('uid-input');
  const loginBtn     = document.getElementById('login-btn');
  const mainUI       = document.getElementById('main-ui');
  const counterEl    = document.getElementById('stamp-counter');
  const startScanBtn = document.getElementById('start-scan');
  const readerDiv    = document.getElementById('reader');
  const scanMsg      = document.getElementById('scan-msg');
  const logoutBtn    = document.getElementById('logout-btn');
  const rewardTxt    = document.getElementById('reward-text');
  const rewardModal  = new bootstrap.Modal(document.getElementById('rewardModal'));

  let scanner;  // global html5-qrcode instance
  let currentUID = localStorage.getItem('uid') || '';
  if(currentUID){ initApp(currentUID); }

  loginBtn.onclick = ()=>{
    const uid = uidInput.value.trim();
    if(!uid) { alert('í•™ë²ˆ/íœ´ëŒ€í°ì„ ì…ë ¥í•˜ì„¸ìš”'); return; }
    localStorage.setItem('uid', uid);
    initApp(uid);
  };

  function initApp(uid){
    authArea.classList.add('d-none');
    mainUI.classList.remove('d-none');
    counterEl.textContent = 'ë‚´ ìŠ¤íƒ¬í”„: ...';
    fetchStamp(uid);
    startScanBtn.onclick = ()=> startScanner(uid);
  }

  async function startScanner(uid){
    if(scanner){ await scanner.stop(); }
    scanMsg.textContent = '';
    readerDiv.classList.remove('d-none');
    startScanBtn.classList.add('d-none');
    scanner = new Html5Qrcode('reader');
    const config = { fps:10, qrbox:230 };
    try{
      await scanner.start({facingMode:'environment'}, config, async decoded=>{
        await sendStamp(uid, decoded.trim());
      });
    }catch(err){
      scanMsg.textContent = 'ì¹´ë©”ë¼ ì‚¬ìš©ì„ í—ˆìš©í•´ì•¼ í•©ë‹ˆë‹¤.';
      readerDiv.classList.add('d-none');
      startScanBtn.classList.remove('d-none');
    }
  }

  logoutBtn.onclick = async ()=>{
    if(scanner){ try{ await scanner.stop(); }catch(e){} }
    localStorage.removeItem('uid');
    mainUI.classList.add('d-none');
    authArea.classList.remove('d-none');
    uidInput.value='';
  };

  /* -------- API CALLS -------- */
  async function fetchStamp(uid){
    try{
      const r = await fetch(`${SCRIPT_API_BASE}?mode=status&uid=${encodeURIComponent(uid)}`);
      const j = await r.json();
      if(j.ok) updateCounter(j.stamps);
    }catch(e){ counterEl.textContent='ì˜¤ë¥˜'; }
  }
  async function sendStamp(uid, loc){
    try{
      const r = await fetch(`${SCRIPT_API_BASE}?mode=stamp&uid=${encodeURIComponent(uid)}&loc=${encodeURIComponent(loc)}`);
      const j = await r.json();
      if(!j.ok){ scanMsg.textContent = j.msg; return; }
      updateCounter(j.stamps);
      if(j.reward) { rewardTxt.textContent = j.reward; rewardModal.show(); }
    }catch(e){ scanMsg.textContent = 'ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜'; }
  }
  function updateCounter(stamps){ counterEl.textContent = `ë‚´ ìŠ¤íƒ¬í”„: ${stamps}`; }
  </script>
</body>
</html>

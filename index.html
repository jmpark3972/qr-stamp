<!-- COMPLETE REWRITE: switch to sessionStorage (tabâ€‘scoped), more robust logout, clearer camera handling -->
<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Greenâ€¯Festâ€¯QRâ€¯StampÂ Rally</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <!-- head ëë¶€ë¶„ í˜¹ì€ body ë§¨ ì•„ë˜ -->
<!-- â‘  Bootstrap (ì„ íƒ) -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<!-- â‘¡ html5-qrcode  **ê¼­ ë©”ì¸ ì½”ë“œë³´ë‹¤ ë¨¼ì €** -->
  <script src="https://cdn.jsdelivr.net/npm/html5-qrcode/dist/html5-qrcode.min.js"></script>
  <style>
    body{background:#f6fdf7}
    #reader{width:100%;max-width:380px;margin:auto;border:2px solid #198754;border-radius:12px}
  </style>
</head>
<body class="d-flex flex-column align-items-center gap-3 pt-4">
  <h1 class="h5 fw-bold text-success mb-0">ğŸŒ¿ Greenâ€¯FestÂ QRÂ ìŠ¤íƒ¬í”„ë ë¦¬</h1>

  <!-- ë¡œê·¸ì¸ -->
  <div id="login-view" class="text-center w-100" style="max-width:380px;">
    <label class="form-label fw-semibold mt-3">í•™ë²ˆ / íœ´ëŒ€í° ë²ˆí˜¸</label>
    <input id="uid" class="form-control mb-2" placeholder="20251234" autocomplete="off" />
    <button id="login-btn" class="btn btn-success w-100">ë¡œê·¸ì¸</button>
    <small class="text-muted d-block mt-2">ë¡œê·¸ì¸ í›„ ìŠ¤ìº” ê¸°ëŠ¥ì´ í™œì„±í™”ë©ë‹ˆë‹¤.</small>
  </div>

  <!-- ë©”ì¸ -->
  <div id="app-view" class="d-none w-100 flex-column align-items-center gap-3">
    <div id="counter" class="badge text-bg-success fs-6 px-3 py-2"></div>

    <button id="start-btn" class="btn btn-outline-success mt-2">ğŸ“·Â ì¹´ë©”ë¼ë¡œÂ QRÂ ìŠ¤ìº”</button>
    <div id="reader" class="d-none"></div>
    <div id="error-msg" class="text-danger small mt-1"></div>

    <button id="logout-btn" class="btn btn-outline-secondary btn-sm mt-3">ë¡œê·¸ì•„ì›ƒ</button>
  </div>

  <!-- ë³´ìƒ ëª¨ë‹¬ -->
  <div class="modal fade" id="rewardModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content text-center p-4">
        <h2 class="fw-bold text-success mb-3"> ì¶•í•˜í•©ë‹ˆë‹¤!</h2>
        <p id="reward-text" class="fs-5"></p>
        <button class="btn btn-success" data-bs-dismiss="modal">ë‹«ê¸°</button>
      </div>
    </div>
  </div>

  <script>
  /* ------------- ì„¤ì • ------------- */
  const API = "https://script.google.com/macros/s/AKfycbxBxjOXN-VZe2Ra2qT_x8dyoVhfuoL8_vMiQEJoDXKdpxMwTwWM7rhsKRUj-6kq3R0f/exec"; // â˜… Web App URL
  const MIN_REWARD = 5;

  /* ------------- DOM ------------- */
  const loginView  = document.getElementById('login-view');
  const appView    = document.getElementById('app-view');
  const uidInput   = document.getElementById('uid');
  const loginBtn   = document.getElementById('login-btn');
  const startBtn   = document.getElementById('start-btn');
  const readerDiv  = document.getElementById('reader');
  const counter    = document.getElementById('counter');
  const logoutBtn  = document.getElementById('logout-btn');
  const errMsg     = document.getElementById('error-msg');
  const rewardTxt  = document.getElementById('reward-text');
  const rewardMd   = new bootstrap.Modal(document.getElementById('rewardModal'));

  /* ------------- ìƒíƒœ ------------- */
  let currentUID = sessionStorage.getItem('uid') || '';
  let scanner;

  if(currentUID){ showApp(); }

  /* ------------- ë¡œê·¸ì¸ ------------- */
  loginBtn.onclick = ()=>{
    const uid = uidInput.value.trim();
    if(!uid) return alert('í•™ë²ˆ/íœ´ëŒ€í°ì„ ì…ë ¥í•˜ì„¸ìš”');
    sessionStorage.setItem('uid', uid);
    currentUID = uid;
    showApp();
  };

  function showApp(){
    loginView.classList.add('d-none');
    appView.classList.remove('d-none');
    updateCounter(0);
    jsonp(`${API}?mode=status&uid=${encodeURIComponent(currentUID)}`, r=>{
      if(r.ok) updateCounter(r.stamps);
    });
}
  }

  /* ------------- ì¹´ë©”ë¼ ------------- */
  startBtn.onclick = async ()=>{
    if(scanner){ await scanner.stop(); }
    readerDiv.classList.remove('d-none');
    errMsg.textContent='';
    scanner = new Html5Qrcode('reader');
    try{
      await scanner.start({facingMode:'environment'}, { fps:10, qrbox:230 }, onDecode);
      startBtn.classList.add('d-none');
    }catch(e){
      errMsg.textContent = 'ì¹´ë©”ë¼ ê¶Œí•œì„ í—ˆìš©í•´ì•¼ í•©ë‹ˆë‹¤ (HTTPS ì ‘ì† í•„ìˆ˜)';
      readerDiv.classList.add('d-none');
    }
  };

  async function onDecode(text){
    const loc = text.trim();
    try{
      const r = await fetch(`${API}?mode=stamp&uid=${encodeURIComponent(currentUID)}&loc=${encodeURIComponent(loc)}`);
      const j = await r.json();
      if(!j.ok){ errMsg.textContent = j.msg; return; }
      updateCounter(j.stamps);
      if(j.reward){ rewardTxt.textContent=j.reward; rewardMd.show(); }
    }catch{ errMsg.textContent='ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜'; }
  }

  /* ------------- ìƒíƒœ & ë³´ìƒ ------------- */
  async function fetchStatus(){
    try{
      const r = await fetch(`${API}?mode=status&uid=${encodeURIComponent(currentUID)}`);
      const j = await r.json();
      if(j.ok) updateCounter(j.stamps);
    }catch{}
  }
  function updateCounter(n){ counter.textContent = `ë‚´ ìŠ¤íƒ¬í”„: ${n}`; }

  /* ------------- ë¡œê·¸ì•„ì›ƒ ------------- */
  logoutBtn.onclick = async ()=>{
    if(scanner){ try{ await scanner.stop(); }catch{} }
    scanner=null;
    sessionStorage.removeItem('uid');
    currentUID='';
    readerDiv.classList.add('d-none');
    startBtn.classList.remove('d-none');
    appView.classList.add('d-none');
    loginView.classList.remove('d-none');
    uidInput.value='';
  };
  </script>
</body>
</html>
